<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>classification-in-r</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../RESEDA/contents/Regression-in-R.html" rel="next">
<link href="../../RESEDA/contents/Machine-Learning-Basics.html" rel="prev">
<link href="../../img/favicon.png" rel="icon" type="image/png">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-6a2f87d857dab416d264e7be3d97196c.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "textbox",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../img/RSG-Logo-RGB.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../projects/index.html"> 
<span class="menu-text">Projects</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../staff/index.html"> 
<span class="menu-text">Staff</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../R-Crash-Course/index.html"> 
<span class="menu-text">R Crash Course</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../RESEDA/index.html" aria-current="page"> 
<span class="menu-text">RESEDA</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../About/index.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://blogs.fu-berlin.de/reseda/"> <i class="bi bi-folder-symlink" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://github.com/Remote-Sensing-at-FU-Berlin"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text">Github</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="mailto:marion.stellmes@fu-berlin.de"> <i class="bi bi-envelope" role="img" aria-label="email">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../RESEDA/contents/Analyse.html">Analyse</a></li><li class="breadcrumb-item"><a href="../../RESEDA/contents/Classification-in-R.html">Classification in R</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Overview</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Let’s start!</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Preparations</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/PrepareYourself.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter in a box</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/QGIS.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">QGIS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/R-Studio.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RStudio</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/SNAP.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">SNAP</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true">
 <span class="menu-text">Acquire</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-3" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-3" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Acquireyourdata.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter in a box</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/SensorBasics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Sensor basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Download.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Download</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true">
 <span class="menu-text">Preprocess</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-4" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-4" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Preprocess.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter in a box</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Preprocess-Optical-Data.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preprocess Optical Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Visualization.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Visualization</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true">
 <span class="menu-text">Analyse</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-5" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-5" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Analyse.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter in a box</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Machine-Learning-Basics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Machine Learning Basics</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Classification-in-R.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Classification in R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Regression-in-R.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Regression in R</span></a>
  </div>
</li>
      </ul>
  </li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true">
 <span class="menu-text">Validate</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-6" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-6" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Validate.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter in a box</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Validate.html#create-samples-in-r" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Create Samples in R</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Validate.html#label-samples-in-qgis" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Label Samples in QGIS</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Validate.html#Accuracy-Matrix" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Accuracy Matrix</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../RESEDA/contents/Validate.html#area-adjusted-accuracies" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Area Adjusted Accuracies</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#classification-in-r" id="toc-classification-in-r" class="nav-link active" data-scroll-target="#classification-in-r">Classification in R</a></li>
  <li><a href="#sample-in-qgis" id="toc-sample-in-qgis" class="nav-link" data-scroll-target="#sample-in-qgis">Sample in QGIS</a>
  <ul class="collapse">
  <li><a href="#preliminary-thoughts-about-sampling" id="toc-preliminary-thoughts-about-sampling" class="nav-link" data-scroll-target="#preliminary-thoughts-about-sampling">Preliminary thoughts about sampling</a></li>
  <li><a href="#import-a-raster-dataset" id="toc-import-a-raster-dataset" class="nav-link" data-scroll-target="#import-a-raster-dataset">Import a Raster Dataset</a></li>
  <li><a href="#create-a-new-polygon-shapefile" id="toc-create-a-new-polygon-shapefile" class="nav-link" data-scroll-target="#create-a-new-polygon-shapefile">Create a New Polygon Shapefile</a></li>
  </ul></li>
  <li><a href="#prepare-samples-in-r" id="toc-prepare-samples-in-r" class="nav-link" data-scroll-target="#prepare-samples-in-r">Prepare Samples in R</a>
  <ul class="collapse">
  <li><a href="#in-depth-guide" id="toc-in-depth-guide" class="nav-link" data-scroll-target="#in-depth-guide">In-depth Guide</a></li>
  </ul></li>
  <li><a href="#rf-classification" id="toc-rf-classification" class="nav-link" data-scroll-target="#rf-classification">RF Classification</a>
  <ul class="collapse">
  <li><a href="#in-depth-guide-1" id="toc-in-depth-guide-1" class="nav-link" data-scroll-target="#in-depth-guide-1">In-depth Guide</a></li>
  </ul></li>
  <li><a href="#svm-classification" id="toc-svm-classification" class="nav-link" data-scroll-target="#svm-classification">SVM Classification</a>
  <ul class="collapse">
  <li><a href="#in-depth-guide-2" id="toc-in-depth-guide-2" class="nav-link" data-scroll-target="#in-depth-guide-2">In-depth Guide</a></li>
  </ul></li>
  <li><a href="#learning-curve" id="toc-learning-curve" class="nav-link" data-scroll-target="#learning-curve">Learning Curve</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content"><header id="title-block-header" class="quarto-title-block"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../RESEDA/contents/Analyse.html">Analyse</a></li><li class="breadcrumb-item"><a href="../../RESEDA/contents/Classification-in-R.html">Classification in R</a></li></ol></nav></header>




<section id="classification-in-r" class="level1 entry-title">
<h1 class="entry-title">Classification in R</h1>
<section id="vorab-zuschneiden-und-dann-aus-dem-code-später-herausnehmen" class="level4">
<h4 class="anchored" data-anchor-id="vorab-zuschneiden-und-dann-aus-dem-code-später-herausnehmen">vorab zuschneiden und dann aus dem code später herausnehmen</h4>
<p>We want to utilize a Random Forest (RF) and a Support Vector Classifier (SVM) algorithm in order to classify the Berlin land cover in six elementary categories: <em>bare soil</em>, <em>water</em>, <em>grassland</em>, <em>forest</em>, <em>urban low density</em>, and <em>urban high density</em>. Therefore, we need an image dataset and a shapefile containing points or polygons to which the respective class is attributed.</p>
<p>The workflow will be exemplified by a L9 scene (ID: LC09_L2SP_193023_20240512_20240513_02_T1), which you may already have acquired during the <a href="../../RESEDA/contents/Download.html#EarthExplorer" rel="noopener" target="_blank">L8/L9 Download Exercise</a>. You need to preprocess the scene as shown in chapter <a href="./Preprocess-Optical_Data.qmd#landsat-8-preprocessing">Preprocess</a>. In addition, we narrowed our research area to Berlin to keep the data small (as shown in chapter <a href="../../RESEDA/contents/Visualization.html">Visualize in R</a>).</p>
<p>You can download both the preprocessed image and the shapefile for testing purposes <a href="http://####/">here</a>.</p>
<div style="background-color:#f1f1f1;padding:18px 30px 1px">
<p>This section guides you through a complete classification process for satellite imagery. The resulting classification maps will be validated in the <a href="./validate.qmd">next chapter</a>.</p>
<p><strong>Sample in QGIS</strong> – some basic considerations and tips for sampling<br>
– collect training polygons in QGIS for supervised classification<br>
<strong>Prepare Samples in R</strong> – import training polygons into R<br>
– use training polygons to extract raster information<br>
– put everything together in a data frame<br>
<strong>RF Classification</strong> – train a RF model with “randomForest” package<br>
– classify image data and export a classification image<br>
<strong>SVM Classification</strong> – train a SVM (C-Classification method) with “e1071” package<br>
– classify image data and export a classification image</p>
</div>
</section>
</section>
<section id="sample-in-qgis" class="level1 entry-title">
<h1 class="entry-title">Sample in QGIS</h1>
<p>This section provides a guide on how to create training areas in the form of polygons, which we save in a shapefile in QGIS. If you prefer you can likewise create a geopackage- file. The process is very similar to collecting samples in ArcGIS/SNAP, which you already know from our GIS seminars.</p>
<p>Collecting training areas is essential when working with supervised classifiers and significantly influences the classification outputs. You should make some preliminary considerations and approach the sampling very carefully! In the following, we will focus on the most important basics to consider.</p>
<section id="preliminary-thoughts-about-sampling" class="level2">
<h2 class="anchored" data-anchor-id="preliminary-thoughts-about-sampling">Preliminary thoughts about sampling</h2>
<p>Probably the most frequently asked questions are how many polygons should be created by class and and how big should they be?<br>
– Good questions!</p>
<p>Unfortunately, those just can not be answered directly. The amount of training data you need, i.e., polygon count and size, depends both on the</p>
<ul>
<li>complexity of your classification problem (number and similarity of target classes, …) &amp;</li>
<li>complexity of your classification algorithm (number of parameters or weights, RF, SVM, ANN, ML, …).</li>
</ul>
<p>####Examine links! Sampling data in machine learning is a science in itself, which is why there is a wealth of scientific publications about it (<a href="https://www.sciencedirect.com/science/article/pii/003442578690012X" rel="noopener" target="_blank">Curran &amp; Williamson 1986</a>, <a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3307431/pdf/1472-6947-12-8.pdf" rel="noopener" target="_blank">Figueroa et al.&nbsp;2012</a>) and even entire books (<a href="https://books.google.de/books?id=uspzLjVWNgMC&amp;printsec=frontcover&amp;hl=de&amp;source=gbs_ge_summary_r&amp;cad=0#v=onepage&amp;q&amp;f=false" rel="noopener" target="_blank">Marchetti et al.&nbsp;2006</a>, <a href="https://books.google.de/books?id=tVIjmNS3Ob8C&amp;printsec=frontcover&amp;dq=The+Elements+of+Statistical+Learning:+Data+Mining,+Inference,+and+Prediction,+Second+Edition&amp;hl=de&amp;sa=X&amp;ved=0ahUKEwiylJDL76XcAhWDZVAKHdG1CLAQ6AEIKDAA#v=onepage&amp;q=The%20Elements%20of%20Statistical%20Learning%3A%20Data%20Mining%2C%20Inference%2C%20and%20Prediction%2C%20Second%20Edition&amp;f=false" rel="noopener" target="_blank">Hastie et al.&nbsp;2017</a>).</p>
<p>Fine, so far that is not much of a help…</p>
<p>To keep it very simple: You need a sample of your data that represents the problem you want to solve. Keep in mind, a classifier learns a mathematical function, which maps input data (e.g., spectral bands) to output data (e.g., class labels). In order to achieve this, you should provide enough training data to capture the relationships between input and output. <strong>Training data</strong> will optimally meet the following requirements:</p>
<ul>
<li><strong>independence of test data:</strong><br>
A training dataset must be independent of the test dataset used for a validation, but can follow the same probability distribution. No training sample may be used to test (validate) the performance of the classifier! In the context of remote sensing data, it is also important that train and test data are spatially maximally distant avoid spatial autocorrelation (<a href="https://en.wikipedia.org/wiki/Moran%27s_I" rel="noopener" target="_blank">Morans I</a>).</li>
<li><strong>mostly identical distributed:</strong><br>
Each target class should be equally represented in the training data set. Most datasets do not have an exactly equal number of instances in each class. Small differences often do not matter. However, if there is a strong imbalance, e.g., 90% of all training data represent class 1 and only 10% class 2, most algorithms very quickly “overclassify” the more-prevalent classes. Some simple options to avoid this effect: Collect more samples of the low-represented classes, use data augmentation to synthetically create new samples for under-represented classes, or use a under sampling method. The simplest under sampling method is to delete samples from the over-represented classes during classifier training. We will use this latter method for the <a href="../../RESEDA/contents/Classification-in-R.html#rf-classification">RF</a> and <a href="../../RESEDA/contents/Classification-in-R.html#svm-classification/">SVM</a> implementations later on.</li>
<li><strong>representative for target classes:</strong><br>
Training data should cover as many intra-class variations as possible, e.g., all spectral classes of a thematic target class, such as deciduous trees and conifers for the target class “forest”. Especially with more complex, non-linear classifiers, such as RF and SVM, it is important to include near-border training samples to map the class transitions more accurately. For example, water bodies should also be sampled in the shore area rather than just creating polygons in deep water areas.</li>
<li><strong>available in sufficient quantity:</strong><br>
There are statistical heuristic methods available to calculate a suitable sample size. Often a factor of the number of classes, the number of input features or the model parameters are used (e.g., 5 features – 25 training samples per class, <a href="https://www.elsevier.com/books/pattern-recognition/theodoridis/978-1-59749-272-0" rel="noopener" target="_blank">Theodoridis et al.&nbsp;2008</a>) or the minimum number of samples necessary to perform the <a href="https://en.wikipedia.org/wiki/Power_(statistics)" rel="noopener" target="_blank">power calculation</a> is searched (<a href="https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3275906/" rel="noopener" target="_blank">Dell et al.&nbsp;2002</a>). However, these rules are not universally applicable! Anyway, if you have many features, e.g., hundreds of spectral channels in hyperspectral images, it is important to collect even more samples to avoid the <a href="https://en.wikipedia.org/wiki/Curse_of_dimensionality" rel="noopener" target="_blank">curse of dimensionality</a>, i.e., Hughes phenomenon (<a href="https://ieeexplore.ieee.org/document/1054102/?tp=&amp;arnumber=1054102" rel="noopener" target="_blank">Hughes 1968</a>). This curse occurs when the samples can not reflect the possible parameter combinations in such a high dimensional feature space. As a result, the classification accuracy decreases as more features are included in the algorithm. The best way to find out if the training samples are sufficiently set is to plot a <a href="https://en.wikipedia.org/wiki/Learning_curve" rel="noopener" target="_blank">learning curve</a>. A learning curve plots the model performance on the y-axis versus the size of the training dataset on the x-axis as a line. On this way, you may be able to evaluate the amount of data that is required for a solid model performance, or perhaps how little data you actually need before before the learning curve stagnates or even drops again. This plot can be generated during training, as shown in the next sections.</li>
</ul>
<p>Before you start sampling the training data in QGIS, here are some general tips for digitizing your polygons, if you want to perform a monotemporal classification based on spectral features:</p>
<ul>
<li>evenly distribute the polygons for each class over the entire scene to best cover any atmospheric variations that may exist within the image</li>
<li>for each class, try to digitize an area of approximately the same size (sum of all polygons)</li>
<li>keep in mind: each raster pixel under your polygons is a training sample!</li>
<li>avoid huge polygons(!), e.g., creating a huge polygon over a homogeneous lake does not add much value in terms of characterization of the spectral properties of a lake. – create several small polygons covering different lakes instead</li>
<li>take your time! Sampling is an essential processing step and will largely determine your further analysis</li>
</ul>
<p>Enough theory, time to collect training data.</p>
</section>
<section id="import-a-raster-dataset" class="level2">
<h2 class="anchored" data-anchor-id="import-a-raster-dataset">Import a Raster Dataset</h2>
<p>The training polygons should define relevant areas for the differentiation of the desired target classes (<em>bare soil</em>, <em>water</em>, <em>grassland</em>, <em>forest</em>, <em>urban low density</em>, and <em>urban high density</em> in our example). To know where these surfaces are located, we need corresponding image data as a basis. So let us import an image dataset!</p>
<p>First of all, open <a href="../../RESEDA/contents/QGIS.html">QGIS</a>.</p>
<p>There are several ways to open a raster dataset here: Either navigate via the main menu to <em>Layer</em> &gt; <em>Add Layer</em> &gt; <em>Add Raster Layer…</em>, or press the corresponding icon <img src="./img/vis_008.png" class="alignnone size-full wp-image-1909" width="24" height="24"> in the toolbar or press the shortcut <strong>Ctrl + Shift + R</strong> to open a file explorer window.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./img/vis_007.png"><img src="./img/vis_007.png" class="aligncenter img-fluid figure-img" alt="Location of Add Raster Layer-function in QGIS"></a></p>
<figcaption>Location of Add Raster Layer-function in QGIS</figcaption>
</figure>
</div>
<p>In the file explorer window, navigate to the data folder which holds your L9 data and import a raster dataset. We will use a L9 scene showing Berlin (ID: LC09_L2SP_193023_20240512_20240513_02_T1) from the <a href="../../RESEDA/contents/EarthExplorer-Exercise.html" rel="noopener" target="_blank">L9 Download Exercise</a>. The spatial subset can be downloaded <a href="XXX" rel="noopener" target="_blank">here</a> directly:</p>
<p><a href="./img/cla_009.png"><img src="./img/cla_009.png" class="aligncenter img-fluid"></a></p>
<div style="margin: -30px 0 20px 0;text-align: center">
<p><span style="color: #686868;font-size: small">Landsat 9 spatial subset imported into QGIS</span></p>
</div>
<p>If you have started a new QGIS project (or just opened QGIS), the projection of the entire project will be based on the first dataset you load – in this case the raster file. You can see the current projection of the project in the lower right corner of QGIS. If you use our example data set, you should now see <img src="./img/cla_010.png" class="alignnone size-full wp-image-2071" loading="lazy" width="110" height="29"> there. Click on this entry to get more detailed information about coordinate system of our raster dataset (“WGS84 / UTM ZONE 33 N”). Alternatively, you can double-click the dataset in the Layer Panel and view the Coordinate Reference System (CRS) in the General-tab. We want to generate a new shapefile, which shares exactly this georeference system. This is the best way to ensure that the polygons are geographically correctly located in the end.</p>
</section>
<section id="create-a-new-polygon-shapefile" class="level2">
<h2 class="anchored" data-anchor-id="create-a-new-polygon-shapefile">Create a New Polygon Shapefile</h2>
<p>First, navigate to the area of interest (AOI) in your image data. Then click on the New Shapfile Layer <img src="./img/cla_011.png" class="alignnone size-full wp-image-2073" loading="lazy" width="29" height="28"> icon in the toolbar. If you can not find this icon, right-click in the toolbar area and make sure there is a check mark next to “Manage Layer Toolbar”, which should reveal this icon among others. Once clicked, the “New Shapefile Layer” dialog will be displayed. Choose “polygon” as the Type in the top row of the window. Click on the Coordinate System icon. A new window will pup up, allowing you the choose the CRS of your new shapefile. Choose the same CRS as your raster data (you can use the filter function at the top). On the Fields list, select “id”, and click the button <img src="./img/cla_012.png" class="alignnone img-fluid"> at the bottom of the list. Under “New field”, type “classes” in the Name box, click on <img src="./img/cla_013.png" class="alignnone img-fluid">. Finally, this should look like this:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./img/cla_014.png"><img src="./img/cla_014.png" class="aligncenter img-fluid figure-img" alt="New Shapefile dialog settings"></a></p>
<figcaption>New Shapefile dialog settings</figcaption>
</figure>
</div>
<p>If everything is set up, click OK. You will be prompted to the “Save layer as…” dialog. Type the file name (“training_data.shp”), choose a file path and click Save. You will be able to see the new shapefile in the Layers Panel of QGIS. Select it and press the Toggle Editing <img src="./img/cla_015.png" class="alignnone size-full wp-image-2078 img-fluid" width="22"> icon in order to activate editing functionalities. Note that a little pencil symbol will show up on top of the layer, indicating that the layer is now editable. Now click on the Add Feature <img src="./img/cla_016.png" class="alignnone size-full wp-image-2079" loading="lazy" width="22" height="30"> icon. The mouse cursor will now look like a crosshair. Left-click on the map in the Map View to create the first point of your new feature. Keep on left-clicking for each additional point you wish to include in your polygon. When you have finished adding your points, right-click anywhere on the map area to confirm your polygon geometry. An attribute window will appear immediately, asking for your class label. Input the appropriate class label for your polygon and click OK. Click on the Toggle Editing <img src="./img/cla_015.png" class="alignnone img-fluid"> icon again in order to end editing and to save your changes by choosing Save.</p>
<p>You can edit the shape of a polygon with the Node tool <img src="./img/cla_018.png" class="alignnone size-full wp-image-2084" loading="lazy" width="28" height="28">. Delete any unwanted polygons by clicking on the tool called “Select Features by Area or Single Click” <img src="./img/cla_019.png" class="alignnone size-full wp-image-2085" loading="lazy" width="28" height="27">. Once activated you can left-click on polygons you want to delete, causing them to turn yellow. Then, press the delete key on your keyboard to remove the polygons (only in editing mode). Choose “Categorized” in the uppermost drop-down menu.</p>
<p>After some time you should have collected some training areas:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./img/cla_017.png"><img src="./img/cla_017.png" class="aligncenter img-fluid figure-img" alt="Collection of training polygons in one shapefile"></a></p>
<figcaption>Collection of training polygons in one shapefile</figcaption>
</figure>
</div>
<p>You can also color the polygons during editing based on the “classes” attribute, which makes it easier for you to estimate the class distribution. Double-click the shapefile in the Layers Panel and navigate to the Style tab. Ensure that your attribute “classes” is selected in the drop-down menu below. Click Classify once to apply an individual color to each class (click on the colored boxes in order to change the colors) and confirm everything by pressing OK:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="./img/cla_020.png"><img src="./img/cla_020.png" class="aligncenter img-fluid figure-img" alt="Style settings for coloring classes"></a></p>
<figcaption>Style settings for coloring classes</figcaption>
</figure>
</div>
<p>If you think you have collected enough samples, save everything by clicking on the Toggle Editing <img src="./img/cla_015.png" class="alignnone img-fluid"> icon again and choose to Save.<br>
We do not need QGIS anymore, so close it.</p>
</section>
</section>
<section id="prepare-samples-in-r" class="level1 entry-title">
<h1 class="entry-title">Prepare Samples in R</h1>
<p>We want to put the training samples created in the previous section in the form of a data frame – which most classifiers in R can handle easily (especially our RF and SVM algorithms). You can [download the training_data shapefile here]####{target=“_blank” rel=“noopener”}. For this task, we again take advantage of the powerful <a href="https://cran.r-project.org/web/packages/terra/terra.pdf" target="_blank" rel="noopener">terra</a> package. The complete code is shown below and a more detailed description is given afterwards.</p>
<pre class="theme:amityreseda"><code># Load the terra package
library(terra)

# Set the working directory
setwd("./data")

# Import the raster image and shapefile
img &lt;- rast("./landsatdata/LC09_L2SP_193023_20240512_20240513_02_T1.tif")
shp &lt;- vect("./vector/training_data.shp")

#### Shapefile Berlin
# Let's subset the data according to our shapefile and save it.
img &lt;- crop(img, shp, filename=paste0(substr(product, 1, nchar(product) - 4), "_subset.tif"))


# Rename the raster bands
names(img) &lt;- c("b1", "b2", "b3", "b4", "b5", "b6", "b7")

# Extract samples with class labels and put them all together in a dataframe
smp &lt;- extract(img, shp)

# Match the extracted samples with class labels
smp$cl &lt;- as.factor(shp$classes[smp$ID])

# Remove the ID column (the first column) if not needed
smp &lt;- smp[-1]

# Display the resulting dataframe
print(smp)</code></pre>
<p><span id="1"></span></p>
<section id="in-depth-guide" class="level2">
<h2 class="anchored" data-anchor-id="in-depth-guide">In-depth Guide</h2>
<p>In order to use functionalities of the terra package, load it into your current session via <code>library()</code>. If you did not yet install terra, please do so using <code>install.packages()</code>:</p>
<pre class="theme:amityreseda"><code>#install.packages("terra")
library(terra)</code></pre>
<p>Next: set your working directory, in which all your image and shapefile data is stored by giving a character (do not forget the quotation marks <code>" "</code>) variable to <code>setwd()</code>. Check your path with <code>getwd()</code> and the stored files in it via <code>dir()</code>:</p>
<section id="data-folders" class="level4">
<h4 class="anchored" data-anchor-id="data-folders">data folders</h4>
<pre class="theme:amityreseda"><code>setwd("./data")

getwd()
## [1] "/reseda/data/landsatdata"

dir()        
## [1] "LC081930232017060201T1-SC20180613160412_subset.tif"                                                               
## [2] "polygons_training.dbf"                                              
## [3] "polygons_training.prj"                                              
## [4] "polygons_training.qpj"                                              
## [5] "polygons_training.shp"                                              
## [6] "polygons_training.shx"                                              </code></pre>
<p>If you do not get your files listed, you have made a mistake in your work path – check again! Everything ready to go? Fine, then import your raster file as <code>img</code> and your shapefile as <code>shp</code> and have a look at them:</p>
<pre class="theme:amityreseda"><code>img &lt;- rast("LC081930232017060201T1-SC20180613160412_subset.tif")
img
#### 


shp &lt;- shapefile("training_data.shp")
shp

## class       : SpatVector 
## geometry    : polygons 
## dimensions  : 72, 1  (geometries, attributes)
## extent      : 369802.9, 400028.9, 5812457, 5827504  (xmin, xmax, ymin, ymax)
## source      : training_data.shp
## coord. ref. : WGS 84 / UTM zone 33N (EPSG:32633) 
## names       : classes
## type        :   &lt;chr&gt;
## values      :   water
##                 water
##                 water
                 
####
same.crs(shp, img)
## [1] TRUE</code></pre>
<p>Both the <code>rast</code>()<code>and</code>vect()<code>functions are provided by the terra package. As shown above, they create objects of the class SpatRaster and SpatVector respectively. The L9 raster provides 7 bands, and our example shapefile 72 features, i.e., polygons. You can check whether the projections of the two datasets are identical or not by executing</code>same.crs(shp, img)<code>. If this is not the case (output equals *FALSE*), the terra package will automatically re-project your data on the fly later on. However, we recommend to adjust the projections manually in advance to prevent any future inaccuracies using</code>project()<code>.\ Plot your data to make sure everything is imported properly (check [Visualize in R](./Visualization.qmd) for an intro to plotting). With the argument</code>add = TRUE` in line 2 several data layers can be displayed one above the other:</p>
<pre class="theme:amityreseda"><code>plotRGB(img, r = 4, g = 3, b = 2, stretch = "lin")
plot(shp, col="red", add=TRUE)</code></pre>
<p>[<img src="./img/cla_001.png" class="aligncenter img-fluid">(./img/cla_001.png){.fancybox .image}</p>
<p>If you followed this course in the <a href="../../RESEDA/contents/Classification-in-R.html#sample-in-qgis">previous section</a>, your shapefile should provide an attribute called “classes”, which includes your target classes as strings, e.g., “water” or “urban”. We will later turn this column into the <a href="../../R-Crash-Course/index.html">factor</a> data type because classifiers can only work with integer values instead of words like “water” or “urban”. When converting to factors, strings are sorted alphabetically and numbered consecutively. In order to be able to read the classification image at the end, you should make a note of your classification key:</p>
<pre class="theme:amityreseda"><code>levels(as.factor(shp$classes))
## [1] "baresoil"  "forest"    "grassland" "urban_hd"  "urban_ld"  "water"

for (i in 1:length(unique(shp$classes))) {cat(paste0(i, " ", levels(as.factor(shp$classes))[i]), sep="\n")}
## 1 baresoil
## 2 forest
## 3 grassland
## 4 urban_hd
## 5 urban_ld
## 6 water</code></pre>
<p>The <code>levels()</code> function combines all occurrences in a factor-formatted vector. In the example shown above, value 1 in our classification image will correspond to the <em>baresoil</em> class, value 2 to <em>forest</em>, value 3 to <em>grassland</em>, etc.<br>
<strong>Optional</strong>: Let us take a look at the naming of the raster bands via the <code>names()</code> function. Those names can be quite bulky and cause problems in some illustrations when used as axis labels. You can easily rename it to something more concise by overriding the names with any string vector of the same length:</p>
<pre class="theme:amityreseda"><code>names(img)
## [1] "LC081930232017060201T1.SC20180613160412_subset.1"
## [2] "LC081930232017060201T1.SC20180613160412_subset.2"
## [3] "LC081930232017060201T1.SC20180613160412_subset.3"
## [4] "LC081930232017060201T1.SC20180613160412_subset.4"
## [5] "LC081930232017060201T1.SC20180613160412_subset.5"
## [6] "LC081930232017060201T1.SC20180613160412_subset.6"
## [7] "LC081930232017060201T1.SC20180613160412_subset.7"

names(img) &lt;- c("b1", "b2", "b3", "b4", "b5", "b6", "b7")

names(img)
## [1] "b1" "b2" "b3" "b4" "b5" "b6" "b7"</code></pre>
<p>Appropriate names for the input features are very helpful for orientation and readability. Of course you need to change the vector in line 10 according to your own input features.</p>
<p>Our goal is to extract the raster values (x), i.e., all input feature values, and the class values (y) of every single pixel within our training polygons and put all together in a data frame. This data frame can then be read by our classifier. We extract the raster values using the command <code>extract()</code> from the raster package. The argument <code>df = TRUE</code> guarantees that the output is a data frame:</p>
<pre class="theme:amityreseda"><code>smp &lt;- extract(img, shp, df = TRUE)</code></pre>
<p>It may take some time for this function to complete depending on the spatial resolution of your raster data and the spatial area covered by your polygons. If you have your data stored on an SSD, the process is completed much faster. It may be advisable to save the resulting object to the hard drive <code>save(smp , file = "smp .rda")</code> and load it from the hard disk if necessary <code>load(file = "smp.rda")</code>. On this way, the extract function does not have to be repeated again and again…<br>
The data frame has as many rows as pixels are to be extracted and as many columns as input features are given (in this example the spectral channels). In addition, <code>smp</code> also provides a column named “ID”, which holds the IDs of the former polygon for each pixel (each polygon is automatically assigned an ID). Furthermore, we also know which polygon, i.e., each ID, belongs to which class. Because of this, we can establish a relationship between the deposited ID of each pixel and the class given in the shapefile. We use this to add another column to our data query describing each class. Then we delete the ID column because we do not need it anymore:</p>
<pre class="theme:amityreseda"><code>smp$cl &lt;- as.factor(shp$classes[smp$ID])
smp &lt;- smp[-1]

summary(smp$cl)
##  baresoil    forest grassland  urban_hd  urban_ld     water 
##       719      2074      1226      1284       969       763

str(smp)
## 'data.frame':    7035 obs. of  8 variables:
##  $ b1: num  192 179 189 159 171 164 173 184 144 150 ...
##  $ b2: num  229 203 221 179 194 188 192 208 166 165 ...
##  $ b3: num  321 233 272 188 203 196 208 254 178 177 ...
##  $ b4: num  204 130 164 97 116 108 119 150 83 80 ...
##  $ b5: num  161 156 173 125 146 138 146 166 107 104 ...
##  $ b6: num  100 93 109 63 82 71 82 104 51 46 ...
##  $ b7: num  72 68 81 40 56 51 59 74 32 30 ...
##  $ cl: Factor w/ 6 levels "baresoil","forest",..: 6 6 6 6 6 6 6 6 6 6 ...</code></pre>
<p>Now you are ready to start training your classifier as described in the <a href="./Classification.qmd#rf-classification">next sections</a>!</p>
<p><strong>Optional</strong>: If you only include spectral information in your classifier, as in our example, it is often helpful to plot the so-called spectral profiles, or z-profiles. Those represent the mean values of each class for the individual spectral bands. You can also represent other features, e.g., terrain height or precipitation, however, you must then pay attention to the value range in the presentation and possibly normalize the data at first. The magic here happens in the <code>aggregate()</code> command, which combines all the rows of the same class <code>. \~ cl</code> and calculates the arithmetic mean of those groups <code>FUN = mean</code>. This happens for all classes, in the <code>cl</code> column, where NA values are to be ignored via <code>na.rm = TRUE</code>. The rest of the functions in the following script are for visualization purposes only and include standard functions such as <code>plot()</code>, <code>lines()</code>, <code>grid()</code> and <code>legend()</code>. Use the help function for a detailed description of the arguments!</p>
<pre class="theme:amityreseda"><code>sp &lt;- aggregate( . ~ cl, data = smp, FUN = mean, na.rm = TRUE )

# plot empty plot of a defined size
plot(0,
     ylim = c(min(sp[2:ncol(sp)]), max(sp[2:ncol(sp)])), 
     xlim = c(1, ncol(smp)-1), 
     type = 'n', 
     xlab = "L8 bands", 
     ylab = "reflectance [% * 100]"
     )

# define colors for class representation - one color per class necessary!
mycolors &lt;- c("#fbf793", "#006601", "#bfe578", "#d00000", "#fa6700", "#6569ff")

# draw one line for each class
for (i in 1:nrow(sp)){
  lines(as.numeric(sp[i, -1]), 
        lwd = 4, 
        col = mycolors[i]
        )
  }

# add a grid
grid()

# add a legend
legend(as.character(sp$cl),
       x = "topleft",
       col = mycolors,
       lwd = 5,
       bty = "n"
       )</code></pre>
<p><span id="plot"></span><a href="./img/cla_005.png" class="fancybox image"><img src="./img/cla_005.png" class="aligncenter img-fluid"></a></p>
<p>Note that the values represent only the arithmetic mean of the classes and do not allow any statement about the underlying distribution. However, such a z-profile plot helps to visually assess the separability of classes at the beginning.</p>
</section>
<section id="ab-hier-weiter" class="level4">
<h4 class="anchored" data-anchor-id="ab-hier-weiter">ab hier weiter</h4>
</section>
</section>
</section>
<section id="rf-classification" class="level1 entry-title">
<h1 class="entry-title">RF Classification</h1>
<p>There are some packages available containing the possibility to perform the standard RF algorthm described by <a href="https://www.stat.berkeley.edu/~breiman/randomforest2001.pdf" rel="noopener" target="_blank">Breiman (2001)</a>, e.g., in the <a href="https://cran.r-project.org/web/packages/caret/caret.pdf" rel="noopener" target="_blank">caret</a>, <a href="https://cran.r-project.org/web/packages/randomForest/randomForest.pdf" rel="noopener" target="_blank">randomForest</a>, <a href="https://github.com/imbs-hl/ranger" rel="noopener" target="_blank">ranger</a>, <a href="https://cran.r-project.org/web/packages/xgboost/xgboost.pdf" rel="noopener" target="_blank">xgboost</a>, or <a href="https://cran.r-project.org/web/packages/randomForestSRC/randomForestSRC.pdf" rel="noopener" target="_blank">randomForestSRC</a> packages. However, we will use the package called “randomForest” because it is the most common and therefore best supported.</p>
<p>Below you can see a complete code implementation. While this is already executable with your input data, you should read the following comprehensive in-depth guide to understand the code in detail. Even better: You will learn how to generate numerous useful plots, which do great in each thesis!</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co">#import packages</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="co">#set working directory</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"E:</span><span class="sc">\\</span><span class="st">Work"</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="co">#import image (img) and shapefile (shp)</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>img <span class="ot">&lt;-</span> <span class="fu">rast</span>(<span class="st">"E:</span><span class="sc">\\</span><span class="st">Work</span><span class="sc">\\</span><span class="st">LC081930232017060201T1-SC20180613160412_subset.tif"</span>)</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>shp <span class="ot">&lt;-</span> <span class="fu">vect</span>(<span class="st">"E:</span><span class="sc">\\</span><span class="st">Work</span><span class="sc">\\</span><span class="st">training_data</span><span class="sc">\\</span><span class="st">training_data.shp"</span>)</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co">#extract samples with class labels and put them all together in a dataframe</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(img) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"b1"</span>, <span class="st">"b2"</span>, <span class="st">"b3"</span>, <span class="st">"b4"</span>, <span class="st">"b5"</span>, <span class="st">"b6"</span>, <span class="st">"b7"</span>)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> <span class="fu">extract</span>(img, shp, <span class="at">df =</span> <span class="cn">TRUE</span>)</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>smp<span class="sc">$</span>cl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(shp<span class="sc">$</span>classes[ <span class="fu">match</span>(smp<span class="sc">$</span>ID, <span class="fu">seq_len</span>(<span class="fu">nrow</span>(shp))) ])</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> smp[<span class="sc">-</span><span class="dv">1</span>] <span class="co"># Remove the first column (ID)</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="co">#tune and train rf model</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>smp.size <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">min</span>(<span class="fu">summary</span>(smp<span class="sc">$</span>cl)), <span class="fu">nlevels</span>(smp<span class="sc">$</span>cl))</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>rfmodel <span class="ot">&lt;-</span> <span class="fu">tuneRF</span>(<span class="at">x =</span> smp[, <span class="sc">-</span><span class="fu">ncol</span>(smp)],  </span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>                  <span class="at">y =</span> smp<span class="sc">$</span>cl,           </span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>                  <span class="at">sampsize =</span> smp.size, </span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>                  <span class="at">strata =</span> smp<span class="sc">$</span>cl, </span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>                  <span class="at">ntree =</span> <span class="dv">250</span>, </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>                  <span class="at">importance =</span> <span class="cn">TRUE</span>, </span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>                  <span class="at">doBest =</span> <span class="cn">TRUE</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a><span class="co">#save the rf model</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(rfmodel, <span class="at">file =</span> <span class="st">"rfmodel.RData"</span>)</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a><span class="co">#predict image data with rf model</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">predict</span>(img,</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>                  rfmodel,</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>                  <span class="at">filename =</span> <span class="st">"classification_RF.tif"</span>,</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>                  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="in-depth-guide-1" class="level2">
<h2 class="anchored" data-anchor-id="in-depth-guide-1">In-depth Guide</h2>
<p>In order to be able to use the functions of the randomForest package, we must additionally load the library into the current session via <code>library()</code>. If you do not use our VM, you must first download and install the packages with <code>install.packages()</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("terra")</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("randomForest")</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(terra)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>First, it is necessary to process the training samples in the form of a data frame. The necessary steps are described in detail in the <a href="./Classification.qmd#prepare-samples">previous section</a>.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(img) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"b1"</span>, <span class="st">"b2"</span>, <span class="st">"b3"</span>, <span class="st">"b4"</span>, <span class="st">"b5"</span>, <span class="st">"b6"</span>, <span class="st">"b7"</span>)</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> <span class="fu">extract</span>(img, shp, <span class="at">df =</span> <span class="cn">TRUE</span>)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>smp<span class="sc">$</span>cl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(shp<span class="sc">$</span>classes[<span class="fu">match</span>(smp<span class="sc">$</span>ID, <span class="fu">seq_len</span>(<span class="fu">nrow</span>(shp)))])</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> smp[<span class="sc">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After that, you can identify the number of available training samples per class with <code>summary()</code>. There is often an imbalance in the number of those training pixels, i.e., one class is represented by a large number of pixels, while another class has very few samples:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(smp<span class="sc">$</span>cl)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  baresoil    forest grassland  urban_hd  urban_ld     water </span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="do">##       719      2074      1226      1284       969       763</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This often leads to the problem that classifiers favor and overclass strongly-represented classes in the classification. However, the Random Forest Algorithm, as an ensemble classifier, provides an ideal solution to compensate for this imbalance. For each decision tree, we draw a bootstrap sample from the minority class (class with the fewest samples). Then, we randomly draw the same number of cases, with replacement, from all other classes. This technique is called down-sampling.<br>
In our example this is the class <em>baresoil</em> with 719 samples. With the <code>rep()</code> function we form a vector where the length corresponds to the number of target classes. We will use this vector to tell the classifier how many samples it should randomly draw per class for each decision tree during training:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">table</span>(smp<span class="sc">$</span>cl)  <span class="co"># Get class frequencies</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  baresoil    forest grassland  urban_hd  urban_ld     water </span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a><span class="do">##       719      2074      1226      1284       969       763</span></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>smp_freq <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">table</span>(smp<span class="sc">$</span>cl))  <span class="co"># ✅ Convert freq to a usable format</span></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>min_count <span class="ot">&lt;-</span> <span class="fu">min</span>(smp_freq<span class="sc">$</span>Freq)  <span class="co"># ✅ Use column 'Freq' for the frequency count</span></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>num_levels <span class="ot">&lt;-</span> <span class="fu">nrow</span>(smp_freq)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Number of unique classes</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>smp_size <span class="ot">&lt;-</span> <span class="fu">rep</span>(min_count, num_levels)</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>smp_size</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 719 719 719 719 719 719</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The complete training takes place via just one function call of <code>tuneRF()</code>! This function automatically searches for the best parameter setting for <em>mtry</em> – the number of variables available for each tree node. So we just have to worry about <code>ntree</code>, i.e., the number of trees to grow. 250-1000 trees are usually sufficient. Basically, the more the better, but many trees will increase the calculation time. When <code>tuneRF()</code> is called, we need to specify the training samples as <code>x</code>, i.e., all columns of our <code>smp</code> dataframe except the last one, and the corresponding class labels as <code>y</code>, i.e.&nbsp;the last column of our <code>smp</code> dataframe called “cl”:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>smp_df <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(smp, <span class="at">xy =</span> <span class="cn">FALSE</span>)  <span class="co"># Extract values without coordinates</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>smp_df<span class="sc">$</span>cl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(smp_df<span class="sc">$</span>cl)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>smp_freq <span class="ot">&lt;-</span> <span class="fu">as.data.frame</span>(<span class="fu">table</span>(smp_df<span class="sc">$</span>cl))</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>min_count <span class="ot">&lt;-</span> <span class="fu">min</span>(smp_freq<span class="sc">$</span>Freq)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>smp_size <span class="ot">&lt;-</span> <span class="fu">rep</span>(min_count, <span class="fu">nrow</span>(smp_freq))</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>rfmodel <span class="ot">&lt;-</span> <span class="fu">tuneRF</span>(</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> smp_df[, <span class="sc">-</span><span class="fu">ncol</span>(smp_df)],</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> smp_df<span class="sc">$</span>cl,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">sampsize =</span> smp_size,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">strata =</span> smp_df<span class="sc">$</span>cl,  </span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">ntree =</span> <span class="dv">250</span>,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">importance =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">doBest =</span> <span class="cn">TRUE</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="do">## mtry = 2  OOB error = 2.5% </span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="do">## Searching left ...</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="do">## mtry = 1     OOB error = 2.54% </span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="do">## -0.01704545 0.05 </span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="do">## Searching right ...</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="do">## mtry = 4     OOB error = 2.7% </span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a><span class="do">## -0.07954545 0.05                                       </span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In line 3, we pass our <code>smp.size</code> to define how many samples it should draw per class, and <code>strata =</code> at line 4 defines the column which should use for this stratified sampling. The argument <code>importance =</code> in line 6 allows the subsequent assessment of the variable importance when set to <code>TRUE</code>. By setting the argument <code>doBest</code> to <code>TRUE</code>, the RF with the optimal <em>mtry</em> is output directly from the function.</p>
<p><a href="./img/cla_006.png"><img src="./img/cla_006.png" class="img-fluid"></a></p>
<p>If you use <code>tuneRF</code>, you will automatically get a plot that will tell you the OOB errors in the dependency of different <em>mtry</em> settings. As mentioned, the feature automatically identifies the best <em>mtry</em> setting and uses this to generate the optimal RF.</p>
<p>When the model is created, we get some really useful information by executing the object name. First we get the command call with which we trained the model and the final number of variables tried at each split, i.e.&nbsp;the <em>mtry</em> parameter. Furthermore, we get an averaged out of bag (OOB) estimate, as well as a complete confusion matrix based on the training data! The column headers contain the classes of training pixels and the rows describe the corresponding classification. For a more detailed description of a confusion matrix, please refer to the chapter <a href="../../RESEDA/contents/Validate.html">Validate Classifiers</a>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>rfmodel</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Call:</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="do">##  randomForest(x = smp[-ncol(smp)], y = smp$cl, ntree = 300, mtry = mtry.opt,      </span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a><span class="do">##               strata = smp$cl, sampsize = smpsize, importance = TRUE) </span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="do">##                Type of random forest: classification</span></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="do">##                      Number of trees: 300</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="do">## No. of variables tried at each split: 2</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a><span class="do">##         OOB estimate of  error rate: 2.52%</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="do">## Confusion matrix:</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a><span class="do">##           baresoil forest grassland urban_hd urban_ld water class.error</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a><span class="do">## baresoil       708      0         2        3        6     0 0.015299026</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a><span class="do">## forest           0   2060         2        0       11     1 0.006750241</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a><span class="do">## grassland        4      0      1220        0        2     0 0.004893964</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a><span class="do">## urban_hd        18      0         0     1204       62     0 0.062305296</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a><span class="do">## urban_ld         7     10         9       39      904     0 0.067079463</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a><span class="do">## water            0      0         0        1        0   762 0.001310616</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Before we started the training procedure, we set the argument <code>importance = true</code>, which now allow us to have a look at the importance variable using the <code>varImpPlot</code> command:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">varImpPlot</span>(rfmodel)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="./img/cla_002.png"><img src="./img/cla_002.png" class="img-fluid"></a></p>
<p>The <a href="../../RESEDA/contents/Machine-Learning-Basics.html#random-forest" rel="noopener" target="_blank">variable importance</a> shows the most significant or important features for the classification, which are band 5 and 6 in this case. For details of those metrics, please refer to the <a href="../../RESEDA/contents/Machine-Learning-Basics.html#random-forest" rel="noopener" target="_blank">Random Forest Section</a>. However, it is interesting to note that the most important bands also provide the largest spectral differences between the classes <a href="./Classification.qmd#prepare-samples" rel="noopener" target="_blank">in the previous section</a>.</p>
<p>Additionally, you can plot the RF model itself, which shows you the relationship between <a href="../../RESEDA/contents/Machine-Learning-Basics.html#random-forest" rel="noopener" target="_blank">OOB Error</a> and the number of trees used. We can color the lines by passing a vector of <a href="https://en.wikipedia.org/wiki/Web_colors" rel="noopener" target="_blank">hex-colors</a> whose length equals the number of classes + 1 – the first color is the average OOB line, which is also plotted automatically:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(rfmodel, <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"#000000"</span>, <span class="st">"#fbf793"</span>, <span class="st">"#006601"</span>, <span class="st">"#bfe578"</span>, <span class="st">"#d00000"</span>, <span class="st">"#fa6700"</span>, <span class="st">"#6569ff"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="./img/cla_003.png"><img src="./img/cla_003.png" class="img-fluid"></a></p>
<p>We can see a decrease in the error with increasing number of trees, where the urban classes have the highest OOB error values.</p>
<p>Save the model by using the <code>save()</code> function. This function saves the model object <code>rfmodel</code> to your working directory, so that you have it permanently stored on your hard drive. If needed, you can load it any time with <code>load()</code>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(rfmodel, <span class="at">file =</span> <span class="st">"rfmodel.RData"</span>)</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="co">#load("rfmodel.RData")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Since your model is now fully trained, you can use it to predict all the pixels in your image. The command method <code>predict()</code> takes a lot of work from you: It is recognized that there is an image which then passes through your Random Forest pixel by pixel. As with the training pixels, each image pixel is now individually classified and finally reassembled into your final classification image. Use the argument <code>filename =</code> to specify the name of your output map:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">predict</span>(</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  img, </span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>  rfmodel, </span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">filename =</span> <span class="st">"classification.tif"</span>, </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(result)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Random Forest classification completed!<br>
If you store the result of the <code>predict()</code> function in an object, e.g., <code>result</code>, you can plot the map using the standard plot command and passing this object:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">classify</span>(result, <span class="fu">data.frame</span>(<span class="fu">unique</span>(<span class="fu">values</span>(result)), <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(<span class="fu">unique</span>(<span class="fu">values</span>(result)))))  <span class="co"># Ensure proper factor levels</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="fu">coltab</span>(result) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"#fbf793"</span>, <span class="co"># baresoil</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"#006601"</span>, <span class="co"># forest</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"#bfe578"</span>, <span class="co"># grassland</span></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"#d00000"</span>, <span class="co"># urban_hd</span></span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"#fa6700"</span>, <span class="co"># urban_ld</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"#6569ff"</span>  <span class="co"># water</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(result, <span class="at">axes =</span> <span class="cn">FALSE</span>, <span class="at">box =</span> <span class="cn">FALSE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="./img/cla_004-1.png"><img src="./img/cla_004-1.png" class="img-fluid"></a></p>
</section>
</section>
<section id="svm-classification" class="level1 entry-title">
<h1 class="entry-title">SVM Classification</h1>
<p>Just as with the Random Forest, there are quite a few R packages that provide SVM, e.g., <a href="https://cran.r-project.org/web/packages/caret/caret.pdf" rel="noopener" target="_blank">caret</a>, <a href="https://cran.r-project.org/web/packages/e1071/e1071.pdf" rel="noopener" target="_blank">e1071</a>, or <a href="https://cran.r-project.org/web/packages/kernlab/kernlab.pdf" rel="noopener" target="_blank">kernLab</a>. We will use the e1071 package, as it offers <a href="https://cran.r-project.org/web/packages/e1071/vignettes/svmdoc.pdf" rel="noopener" target="_blank">an interface to the well-known libsvm</a> implementation.</p>
<p>Below you can see a complete code implementation. While this is already executable with your input data, you should read the comprehensive in-depth guide in the following to understand the code in detail.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import packages</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(e1071)</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="co"># import image (img) and shapefile (shp)</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"/media/sf_exchange/landsatdata/"</span>)</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>img <span class="ot">&lt;-</span> <span class="fu">brick</span>(<span class="st">"LC081930232017060201T1-SC20180613160412_subset.tif"</span>)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>shp <span class="ot">&lt;-</span> <span class="fu">shapefile</span>(<span class="st">"training_data.shp"</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a><span class="co"># extract samples with class labels and put them all together in a dataframe</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(img) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"b1"</span>, <span class="st">"b2"</span>, <span class="st">"b3"</span>, <span class="st">"b4"</span>, <span class="st">"b5"</span>, <span class="st">"b6"</span>, <span class="st">"b7"</span>)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> <span class="fu">extract</span>(img, shp, <span class="at">df =</span> <span class="cn">TRUE</span>)</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>smp<span class="sc">$</span>cl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>( shp<span class="sc">$</span>classes[ <span class="fu">match</span>(smp<span class="sc">$</span>ID, <span class="fu">seq</span>(<span class="fu">nrow</span>(shp)) ) ] )</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> smp[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a><span class="co"># optional: shuffle samples and undersample if necessary</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> smp[<span class="fu">sample</span>(<span class="fu">nrow</span>(smp)),]</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> smp[<span class="fu">ave</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="fu">nrow</span>(smp)), smp<span class="sc">$</span>cl, <span class="at">FUN =</span> seq) <span class="sc">&lt;=</span> <span class="fu">min</span>(<span class="fu">summary</span>(smp<span class="sc">$</span>cl)), ]</span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co"># tune and train model via gridsearch (gamma &amp; cost)</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a>gammas <span class="ot">=</span> <span class="dv">2</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">8</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>costs <span class="ot">=</span> <span class="dv">2</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>svmgs <span class="ot">&lt;-</span> <span class="fu">tune</span>(svm,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>              <span class="at">train.x =</span> smp[<span class="sc">-</span><span class="fu">ncol</span>(smp)],</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a>              <span class="at">train.y =</span> smp<span class="sc">$</span>cl,</span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>              <span class="at">scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a>              <span class="at">kernel =</span> <span class="st">"radial"</span>, </span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>              <span class="at">type =</span> <span class="st">"C-classification"</span>,</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>              <span class="at">ranges =</span> <span class="fu">list</span>(<span class="at">gamma =</span> gammas,</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>                            <span class="at">cost =</span> costs),</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>              <span class="at">tunecontrol =</span> <span class="fu">tune.control</span>(<span class="at">cross =</span> <span class="dv">5</span>)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>              )</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a><span class="co"># save svmmodel</span></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>svmmodel <span class="ot">&lt;-</span> svmgs<span class="sc">$</span>best.model</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(svmmodel, <span class="at">file =</span> <span class="st">"svmmodel.RData"</span>)</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb23-38"><a href="#cb23-38" aria-hidden="true" tabindex="-1"></a><span class="co"># predict image data with svm model</span></span>
<span id="cb23-39"><a href="#cb23-39" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">predict</span>(img,</span>
<span id="cb23-40"><a href="#cb23-40" aria-hidden="true" tabindex="-1"></a>                  svmmodel,</span>
<span id="cb23-41"><a href="#cb23-41" aria-hidden="true" tabindex="-1"></a>                  <span class="at">filename =</span> <span class="st">"classification_svm.tif"</span>,</span>
<span id="cb23-42"><a href="#cb23-42" aria-hidden="true" tabindex="-1"></a>                  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb23-43"><a href="#cb23-43" aria-hidden="true" tabindex="-1"></a>                  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><br>
</p>
<section id="in-depth-guide-2" class="level2">
<h2 class="anchored" data-anchor-id="in-depth-guide-2">In-depth Guide</h2>
<p>In order to be able to use the functions of the e1071 package, we must additionally load the library into the current session via [library()<code>. If you do not use our VM, you must first download and install the packages with</code>install.packages()`:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("raster")</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="co">#install.packages("e1071")</span></span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(e1071)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>First, it is necessary to process the training samples in the form of a data frame. The necessary steps are described in detail in the <a href="./Classification.qmd#prepare-samples-in-r">previous section</a>.</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(img) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"b1"</span>, <span class="st">"b2"</span>, <span class="st">"b3"</span>, <span class="st">"b4"</span>, <span class="st">"b5"</span>, <span class="st">"b6"</span>, <span class="st">"b7"</span>)</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> <span class="fu">extract</span>(img, shp, <span class="at">df =</span> <span class="cn">TRUE</span>)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>smp<span class="sc">$</span>cl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>( shp<span class="sc">$</span>classes[ <span class="fu">match</span>(smp<span class="sc">$</span>ID, <span class="fu">seq</span>(<span class="fu">nrow</span>(shp)) ) ] )</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> smp[<span class="sc">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After that, you can identify the number of available training samples per class with <code>summary()</code>. There is often an imbalance in the number of those training pixels, i.e., one class is represented by a large number of pixels, while another class has very few samples:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(smp<span class="sc">$</span>cl)</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  baresoil    forest grassland  urban_hd  urban_ld     water </span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="do">##       719      2074      1226      1284       969       763</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This often leads to the problem that classifiers favor and overclass strongly-represented classes in the classification. Unfortunately, a SVM can not handle this problem as elegantly as <a href="../../RESEDA/contents/Machine-Learning-Basics.html#random-forest" rel="noopener" target="_blank">Random Forest</a> methods, why you might need to prepare your training [data:\](data:){.uri} <strong>Only if your data is imbalanced</strong>, you should consider to do the following undersampling: We shuffle our entire training dataset and pick out the same number of samples for each class. The purpose of shuffle is to prevent sampling of all pixels that are next to each other (spatial autocorrelation). The training data is mixed using the <code>sample()</code> method. We sample all rows of our dataset <code>nrow(smp)</code> in a random manner in line 10:</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(smp)</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="do">##    b1  b2  b3  b4  b5  b6 b7    cl</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="do">## 1 192 229 321 204 161 100 72 water</span></span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="do">## 2 179 203 233 130 156  93 68 water</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a><span class="do">## 3 189 221 272 164 173 109 81 water</span></span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="do">## 4 159 179 188  97 125  63 40 water</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="do">## 5 171 194 203 116 146  82 56 water</span></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a><span class="do">## 6 164 188 196 108 138  71 51 water</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> smp[<span class="fu">sample</span>(<span class="fu">nrow</span>(smp)), ]</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(smp)</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a><span class="do">##       b1  b2  b3  b4   b5   b6   b7       cl</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="do">## 2024 176 195 324 234 2146 1022  479   forest</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a><span class="do">## 5545 409 517 844 988 3038 3005 1818 baresoil</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a><span class="do">## 2877 195 212 363 293 2500 1435  690   forest</span></span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="do">## 6210 303 322 482 411 2465 1410  872 urban_hd</span></span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="do">## 6613 367 418 672 600 2855 1876 1210 urban_ld</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a><span class="do">## 321  163 178 201 136  124   76   56    water</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Compare the first six entries of the <code>smp</code> dataset before and after the command in line 10 using the <code>head()</code> function. You will notice that the order of the rows is shuffled!<br>
With the <code>min()</code> function, we can select the minimum value from the class column’s summary and use the <code>ave()</code> function to make a selection of the same size for each class:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(smp<span class="sc">$</span>cl)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="do">##  baresoil    forest grassland  urban_hd  urban_ld     water </span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="do">##       719      2074      1226      1284       969       763</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>smp.maxsamplesize <span class="ot">&lt;-</span> <span class="fu">min</span>(<span class="fu">summary</span>(smp<span class="sc">$</span>cl))</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>smp.maxsamplesize</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a><span class="do">## [1] 719</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> smp[<span class="fu">ave</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="fu">nrow</span>(smp)), smp<span class="sc">$</span>cl, <span class="at">FUN =</span> seq) <span class="sc">&lt;=</span> smp.maxsamplesize, ]</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(smp<span class="sc">$</span>cl)</span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  baresoil    forest grassland  urban_hd  urban_ld     water </span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a><span class="do">##       719       719       719       719       719       719</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let the training begin!<br>
Classifications using an SVM require two parameters: one gamma <span class="math inline">\(\gamma\)</span> and one cost <span class="math inline">\(C\)</span> value (for more details refer to the <a href="./Classification-in-R#svm-classification" rel="noopener" target="_blank">SVM section</a>). These hyperparameters significantly determine the performance of the model. Finding the best hyparameters is not trivial and the best combination can not be determined in advance. Thus, we try to find the best combination by trial and error. Therefore, we create two vectors comprising all values that should be tried out:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>gammas <span class="ot">=</span> <span class="dv">2</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">8</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>gammas</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1]  0.00390625  0.00781250  0.01562500  0.03125000  0.06250000</span></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="do">##  [6]  0.12500000  0.25000000  0.50000000  1.00000000  2.00000000</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="do">## [11]  4.00000000  8.00000000 16.00000000 32.00000000</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>costs <span class="ot">=</span> <span class="dv">2</span><span class="sc">^</span>(<span class="sc">-</span><span class="dv">5</span><span class="sc">:</span><span class="dv">8</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>costs</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="do">##  [1]   0.03125   0.06250   0.12500   0.25000   0.50000   1.00000   2.00000</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="do">##  [8]   4.00000   8.00000  16.00000  32.00000  64.00000 128.00000 256.00000</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>So we have 14 different values for <span class="math inline">\(\gamma\)</span> and 14 different values for <span class="math inline">\(C\)</span>. Thus, the whole training process is done for 196 (14 * 14) models, often referred to as <strong>gridsearch</strong>. Conversely, this means that the more parameters we check, the longer the training process takes.<br>
We start the training with the <code>tune()</code> function. We need to specify the training samples as <code>train.x</code>, i.e., all columns of our <code>smp</code> dataframe except the last one, and the corresponding class labels as <code>train.y</code>, i.e.&nbsp;the last column of our <code>smp</code> dataframe:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>svmgs <span class="ot">&lt;-</span> <span class="fu">tune</span>(svm,</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>              <span class="at">train.x =</span> smp[<span class="sc">-</span><span class="fu">ncol</span>(smp)],</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>              <span class="at">train.y =</span> smp[ <span class="fu">ncol</span>(smp)],</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>              <span class="at">type =</span> <span class="st">"C-classification"</span>,</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a>              <span class="at">kernel =</span> <span class="st">"radial"</span>, </span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>              <span class="at">scale =</span> <span class="cn">TRUE</span>,</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>              <span class="at">ranges =</span> <span class="fu">list</span>(<span class="at">gamma =</span> gammas, <span class="at">cost =</span> costs),</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>              <span class="at">tunecontrol =</span> <span class="fu">tune.control</span>(<span class="at">cross =</span> <span class="dv">5</span>)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>              )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We have to set the <code>type</code> of the SVM to <code>"C-classification"</code> in line 4 in order to perform a classification task. Furthermore, we set the kernel used in training and predicting to a <a href="../../RESEDA/contents/Machine-Learning-Basics.html#support-vector-machine" rel="noopener" target="_blank">RBF kernel</a> via <code>"radial"</code>. We set the argument <code>scale</code> to <code>TRUE</code> in order to initiate the <a href="../../RESEDA/contents/Machine-Learning-Basics.html#support-vector-machine" rel="noopener" target="_blank">z-transformation of our data</a>. The argument <code>ranges</code> in line 7 takes a named list of parameter vectors spanning the sampling range. We put our <code>gammas</code> and <code>costs</code> vectors in this list. By using the <code>tunecontrol</code> argument in line 8, you can set k for <a href="../../RESEDA/contents/Machine-Learning-Basics.html#support-vector-machine" rel="noopener" target="_blank">the k-fold cross validation on the training data</a>, which is necessary to assess the model performance.</p>
<p>Depending on the complexity of the data, this step may take some time. Once completed, you can check the output by calling the resultant object name:</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>svmgs</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="do">## Parameter tuning of 'svm':</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a><span class="do">## - sampling method: 5-fold cross validation </span></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a><span class="do">## - best parameters:</span></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="do">##  gamma cost</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a><span class="do">##      2    8</span></span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a><span class="do">## - best performance: 0.02132796</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In the course of the cross-validation, the overall accuracies were compared and the best parameters were determined: In our example, those are 2 and 8 for <span class="math inline">\(\gamma\)</span> and <span class="math inline">\(C\)</span>, respectively. Furthermore, the error of the best model is displayed: 2.1% error rate (which is quite good!).<br>
We can plot the errors of all 196 different hyperparameter combinations in the so called gridsearch using the standard <code>plot()</code> function:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(svmgs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="./img/cla_022.png"><img src="./img/cla_022.png" class="img-fluid"></a></p>
<p>The plot appears very homogeneous, as the performance varies only very slightly and is already at a very high level. It can happen that the highest accuracies are found on the edge of the grid search. Then the training with other ranges for <span class="math inline">\(\gamma\)</span> and <span class="math inline">\(C\)</span> should be done again.<br>
We can extract the best model out of our <code>svmgs</code> to use for image prediction:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>svmmodel <span class="ot">&lt;-</span> svmgs<span class="sc">$</span>best.model</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>svmmodel</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a><span class="do">## Call:</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="do">## best.tune(method = svm, train.x = smp[-ncol(smp)], train.y = smp$cl, </span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="do">##     ranges = list(gamma = gammas, cost = costs), tunecontrol = tune.control(cross = 5), </span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="do">##     scale = TRUE, kernel = "radial", type = "C-classification")</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a><span class="do">## Parameters:</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a><span class="do">##    SVM-Type:  C-classification </span></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a><span class="do">##  SVM-Kernel:  radial </span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a><span class="do">##        cost:  8 </span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a><span class="do">##       gamma:  2 </span></span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a><span class="do">## </span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a><span class="do">## Number of Support Vectors:  602</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Save the best model by using the <code>save()</code> function. This function saves the model object <code>svmmodel</code> to your working directory, so that you have it permanently stored on your hard drive. If needed, you can load it any time with <code>load()</code>.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="fu">save</span>(svmmodel, <span class="at">file =</span> <span class="st">"svmmodel.RData"</span>)</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co">#load("svmmodel.RData")</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Since your SVM model is now completely trained, you can use it to predict all the pixels in your image. The command method <code>predict()</code> takes a lot of work from you: It is recognized that there is an image which will be processed pixel by pixel. As with the training pixels, each image pixel is now individually classified and finally reassembled into your final classification image. Use the argument <code>filename =</code> to specify the name of your output map:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">predict</span>(img,</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>                  svmmodel,</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>                  <span class="at">filename =</span> <span class="st">"classification_svm.tif"</span>,</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">overwrite =</span> <span class="cn">TRUE</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>                  )</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(result, </span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">axes =</span> <span class="cn">FALSE</span>, </span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">box =</span> <span class="cn">FALSE</span>,</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"#fbf793"</span>, <span class="co"># baresoil</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>             <span class="st">"#006601"</span>, <span class="co"># forest</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>             <span class="st">"#bfe578"</span>, <span class="co"># grassland</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>             <span class="st">"#d00000"</span>, <span class="co"># urban_hd</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>             <span class="st">"#fa6700"</span>, <span class="co"># urban_ld</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>             <span class="st">"#6569ff"</span>  <span class="co"># water</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>             )</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>     )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Support Vector Machine classification completed!<br>
If you store the result of the <code>predict()</code> function in an object, e.g., <code>result</code>, you can plot the map using the standard plot command and passing this object:</p>
<p><a href="./img/cla_007.png"><img src="./img/cla_007.png" class="img-fluid"></a></p>
</section>
</section>
<section id="learning-curve" class="level1 entry-title">
<h1 class="entry-title">Learning Curve</h1>
<p>One question that is asked again and again is the amount of training data needed for a supervised classification. This question is not easy to answer, because every classification and regression problem is different.<br>
However, there is an ideal analysis method to assess this problem for certain: creating a <a href="https://en.wikipedia.org/wiki/Learning_curve" rel="noopener" target="_blank">learning curve</a>:<br>
Simply repeat your training procedure multiple times with different train sample sizes and compare the performance differences!<br>
Plotting those results will (hopefully) show a decreasing error rate with increasing amounts of train data.</p>
<p>In the following, a complete script has been developed, which performs the <a href="../../RESEDA/contents/Classification-in-R.html##rf-classification">RF classification from the previous section</a> <span class="math inline">\(\{2, 4, 8, 16, …, 2048\}\)</span> samples per class ([steps<code>). In order to minimize any random effects and specify a confidence interval, all classifications were repeated 20 times each ([nrepeat</code>).</p>
<p>In order not to unnecessarily inflate the code, we use for loops to iterate over the individual sample sizes and iterations and write the respective results into a matrix <code>r</code>. The following code is comprehensively documented.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="co"># import libraries</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(randomForest)</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="co"># import image (img) and shapefile (shp)</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="fu">setwd</span>(<span class="st">"/media/sf_exchange/landsatdata/"</span>)</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>img <span class="ot">&lt;-</span> <span class="fu">brick</span>(<span class="st">"LC081930232017060201T1-SC20180613160412_subset.tif"</span>)</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>shp <span class="ot">&lt;-</span> <span class="fu">shapefile</span>(<span class="st">"training_data.shp"</span>)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a><span class="co"># extract samples with class labels and put them all together in a dataframe</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(img) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"b1"</span>, <span class="st">"b2"</span>, <span class="st">"b3"</span>, <span class="st">"b4"</span>, <span class="st">"b5"</span>, <span class="st">"b6"</span>, <span class="st">"b7"</span>)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> <span class="fu">extract</span>(img, shp, <span class="at">df =</span> <span class="cn">TRUE</span>)</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>smp<span class="sc">$</span>cl <span class="ot">&lt;-</span> <span class="fu">as.factor</span>(shp<span class="sc">$</span>classes[<span class="fu">match</span>(smp<span class="sc">$</span>ID, <span class="fu">seq</span>(<span class="fu">nrow</span>(shp)))])</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>smp <span class="ot">&lt;-</span> smp[<span class="sc">-</span><span class="dv">1</span>]</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a><span class="co"># number of samples per class chosen for each run</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>steps <span class="ot">&lt;-</span> <span class="dv">2</span><span class="sc">^</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">11</span>)</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a><span class="co"># number of repetitions of each run</span></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>nrepeat <span class="ot">=</span> <span class="dv">20</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a><span class="co"># create empty matrix for final results</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="dv">0</span>, <span class="dv">5</span>, <span class="fu">length</span>(steps))</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(steps)) {</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>  <span class="co"># create empty vector for OOB error from each repetition</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>  rtmp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, nrepeat)</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (j <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nrepeat) {</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># shuffle all samples and subset according to size defined in "steps"</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>    sub <span class="ot">&lt;-</span> smp[<span class="fu">sample</span>(<span class="fu">nrow</span>(smp)),]</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>    sub <span class="ot">&lt;-</span> sub[<span class="fu">ave</span>(<span class="dv">1</span><span class="sc">:</span>(<span class="fu">nrow</span>(sub)), sub<span class="sc">$</span>cl, <span class="at">FUN =</span> seq) <span class="sc">&lt;=</span> steps[i], ]</span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># RF classify as usual</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>    sub.size <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="fu">min</span>(<span class="fu">summary</span>(sub<span class="sc">$</span>cl)), <span class="fu">nlevels</span>(sub<span class="sc">$</span>cl))</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>    rfmodel <span class="ot">&lt;-</span> <span class="fu">tuneRF</span>(<span class="at">x =</span> sub[<span class="sc">-</span><span class="fu">ncol</span>(sub)],</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>                      <span class="at">y =</span> sub<span class="sc">$</span>cl,</span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>                      <span class="at">sampsize =</span> sub.size,</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>                      <span class="at">strata =</span> sub<span class="sc">$</span>cl,</span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>                      <span class="at">ntree =</span> <span class="dv">250</span>,</span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a>                      <span class="at">doBest =</span> <span class="cn">TRUE</span>,<span class="at">plot =</span> <span class="cn">FALSE</span></span>
<span id="cb36-41"><a href="#cb36-41" aria-hidden="true" tabindex="-1"></a>                      )</span>
<span id="cb36-42"><a href="#cb36-42" aria-hidden="true" tabindex="-1"></a>    <span class="co"># extract OOB error rate of last tree (the longest trained) and save to rtmp</span></span>
<span id="cb36-43"><a href="#cb36-43" aria-hidden="true" tabindex="-1"></a>    ooberrors <span class="ot">&lt;-</span> rfmodel<span class="sc">$</span>err.rate[ , <span class="dv">1</span>]</span>
<span id="cb36-44"><a href="#cb36-44" aria-hidden="true" tabindex="-1"></a>    rtmp[j] <span class="ot">&lt;-</span> ooberrors[<span class="fu">length</span>(ooberrors)]</span>
<span id="cb36-45"><a href="#cb36-45" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb36-46"><a href="#cb36-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb36-47"><a href="#cb36-47" aria-hidden="true" tabindex="-1"></a>  <span class="co"># use repetitions to calc statistics (mean, min, max, CI) &amp; save it to final results matrix</span></span>
<span id="cb36-48"><a href="#cb36-48" aria-hidden="true" tabindex="-1"></a>  ttest <span class="ot">&lt;-</span> <span class="fu">t.test</span>(rtmp, <span class="at">conf.level =</span> <span class="fl">0.95</span>)</span>
<span id="cb36-49"><a href="#cb36-49" aria-hidden="true" tabindex="-1"></a>  r[ , i] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">mean</span>(rtmp), ttest<span class="sc">$</span>conf.int[<span class="dv">2</span>], ttest<span class="sc">$</span>conf.int[<span class="dv">1</span>], <span class="fu">max</span>(rtmp), <span class="fu">min</span>(rtmp))</span>
<span id="cb36-50"><a href="#cb36-50" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When the individual experiments have been processed, we can create a nice plot that summarizes the findings:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># conversion in percent</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>r <span class="ot">&lt;-</span> r <span class="sc">*</span> <span class="dv">100</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="co"># plot empty plot without x-axis</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="at">x =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(steps),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>     <span class="at">y =</span> r[<span class="dv">1</span>,],</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylim =</span> <span class="fu">c</span>(<span class="fu">min</span>(r), <span class="fu">max</span>(r)),</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">type =</span> <span class="st">"n"</span>,</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">xaxt =</span> <span class="st">"n"</span>,</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"number of samples per class"</span>,</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"OOB error [%]"</span></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>     )</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a><span class="co"># complete the x-axis </span></span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="fu">axis</span>(<span class="dv">1</span>, <span class="at">at=</span><span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(steps), <span class="at">labels=</span>steps)</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a><span class="co"># add a grid</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a><span class="fu">grid</span>()</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a><span class="co"># draw min-max range of OOB errors</span></span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(steps), <span class="fu">rev</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(steps))), </span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(r[<span class="dv">5</span>, ], <span class="fu">rev</span>(r[<span class="dv">4</span>, ])),</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"grey80"</span>, </span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">border =</span> <span class="cn">FALSE</span></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="co"># draw confidence interval 95%</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a><span class="fu">polygon</span>(<span class="fu">c</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(steps), <span class="fu">rev</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(steps))), </span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">c</span>(r[<span class="dv">3</span>, ], <span class="fu">rev</span>(r[<span class="dv">2</span>, ])),</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">col =</span> <span class="st">"grey60"</span>, </span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">border =</span> <span class="cn">FALSE</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a><span class="co"># draw line of mean OOB </span></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(<span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(steps), r[<span class="dv">1</span>, ], <span class="at">lwd =</span> <span class="dv">3</span>)</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a><span class="co"># add a legend</span></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>,</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>       <span class="fu">c</span>(<span class="st">"mean"</span>, <span class="st">"t-test CI 95%"</span>, <span class="st">"min-max range"</span>),</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"grey80"</span>, <span class="st">"grey60"</span>),</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>       <span class="at">lwd =</span> <span class="dv">3</span>,</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>       <span class="at">bty =</span> <span class="st">"n"</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>       )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><a href="./img/cla_021.png"><img src="./img/cla_021.png" class="img-fluid"></a></p>
<p>Conclusion for this example: From 512 samples per class the achieved improvement is negligible. So 512 samples per class should be enough to get a robust classification.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../RESEDA/contents/Machine-Learning-Basics.html" class="pagination-link" aria-label="Machine Learning Basics">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">Machine Learning Basics</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../RESEDA/contents/Regression-in-R.html" class="pagination-link" aria-label="Regression in R">
        <span class="nav-page-text">Regression in R</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p><span class="faux-block">© 2023 Fernerkundung und Geoinformatik 1.0</span></p>
</div>   
    <div class="nav-footer-center">
<p><span class="faux-block"><a href="https://www.marvinschmitt.com/blog/website-tutorial-quarto/">View the tutorial for this template!</a></span></p>
</div>
    <div class="nav-footer-right">
<p><span class="faux-block"><a href="https://github.com/marvinschmitt/quarto-website-template/">View source on GitHub</a></span></p>
</div>
  </div>
</footer>




</body></html>